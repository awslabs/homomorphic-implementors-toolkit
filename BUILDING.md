# Building HIT with CMake

## HIT Build Steps on Ubuntu 18.04
### Install Build Tool, Compiler and Dependencies

HIT uses CMake (3.12+), and recommends using ninja as generator to speed up build.

HIT supports compilers including GCC9 and Clang10.

Dependencies of HIT includes:
 * [Boost](https://github.com/boostorg/boost)
 * [Google Protobuf](https://github.com/protocolbuffers/protobuf)
 * [Glog](https://github.com/google/glog)
 * [GoogleTest](https://github.com/google/googletest)
 * [TBB](https://github.com/oneapi-src/oneTBB)
 * [Microsoft SEAL](https://github.com/microsoft/SEAL)

For `Boost` and `Google Protobuf`, HIT automatically downloads source code and builds the libraries if they are not found in system.
For other dependencies, HIT does not look for system installed libraries but builds the binary from source code.
HIT recommends installing `Boost` and `Google Protobuf` in system to reduce build time.

The following instructions should have build tool, GCC9 and some dependencies (`Boost` and `Google Protobuf`) installed.
```!bash
set -ex && \
sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y && \
sudo apt-get update && \
sudo apt-get -y --no-install-recommends upgrade && \
sudo apt-get -y --no-install-recommends install \
apt-utils \
software-properties-common \
zlib1g-dev \
ninja-build \
protobuf-compiler \
libprotobuf-dev \
libboost-all-dev \
libcurl4-openssl-dev \
libmsgsl-dev \
libssl-dev \
git \
curl \
ca-certificates && \
cd /tmp && \
curl -LO https://github.com/Kitware/CMake/releases/download/v3.16.3/cmake-3.16.3-Linux-x86_64.tar.gz && \
sudo tar xzf cmake-3.16.3-Linux-x86_64.tar.gz -C /usr --strip-components 1 && \
cmake --version && \
sudo apt-get -y --no-install-recommends install gcc-9 g++-9 && \
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 90 --slave /usr/bin/g++ g++ /usr/bin/g++-9 --slave /usr/bin/gcov gcov /usr/bin/gcov-9 && \
sudo apt-get autoremove --purge -y && \
sudo apt-get clean && \
sudo apt-get autoclean && \
sudo rm -rf /var/lib/apt/lists/* && \
sudo rm -rf /tmp/*
```

**OPTIONAL**: The following instructions have `Clang10`, `clang-tidy` and `clang-format` installed.
```bash
sudo set -ex && \
sudo apt-get update && \
sudo apt-get -y --no-install-recommends install clang clang-10 clang-tidy-10 && \
sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-10 90 --slave /usr/bin/clang++ clang++ /usr/bin/clang-cpp-10 --slave /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-10 && \
sudo apt-get autoremove --purge -y && \
sudo apt-get clean && \
sudo apt-get autoclean && \
sudo rm -rf /var/lib/apt/lists/* && \
sudo rm -rf /tmp/*
```

### Download HIT, Build and Test
```!bash
# Download HIT
git clone https://github.com/awslabs/homomorphic-implementors-toolkit.git
cd homomorphic-implementors-toolkit

# Create build dir
if [ -d build ]; then rm -Rf build; fi
mkdir -p build && cd build

# Run build command
cmake . -Bbuild -GNinja -DCMAKE_BUILD_TYPE=Release -DHIT_BUILD_TESTS=ON -DHIT_BUILD_EXAMPLES=ON
ninja -j $(nproc)

# Run HIT unit tests
ninja run_hit_tests

# Run HIT example
# Before that, GLog variables should be set. Glog reference: https://hpc.nih.gov/development/glog.html
# Show all VLOG(m) messages for m less or equal the value of this flag.
export GLOG_v=1
# Log messages at or above this level.
# The numbers of severity levels INFO, WARNING, ERROR, and FATAL are 0, 1, 2, and 3, respectively.
export GLOG_minloglevel=0
# Set Logging directory.
export GLOG_log_dir="/tmp/hit_log"
if [ -d ${GLOG_log_dir} ]; then rm -Rf ${GLOG_log_dir}; fi
mkdir -p ${GLOG_log_dir}
ninja run_hit_example
```

### HIT CMake Flags
 - `HIT_BUILD_TESTS` (default OFF): Build the unit tests. See TESTING below for more information.
 - `HIT_BUILD_EXAMPLES` (default OFF): Build the HIT example.
 - `HIT_RUN_CLANG_TIDY` (default OFF): Run clang-tidy on the hand-written source code (but not code generated by protobufs), and make the build fail if clang-tidy emits any warnings.
 - `HIT_RUN_CLANG_FORMAT` (default OFF): Run clang-format on the source code, and apply changes in-place.
